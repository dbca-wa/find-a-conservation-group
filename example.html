<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.5.1/dist/leaflet.css"
   integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
   crossorigin=""/>

   <!-- Make sure you put this AFTER Leaflet's CSS -->
 <script src="https://unpkg.com/leaflet@1.5.1/dist/leaflet.js"
 integrity="sha512-GffPMF3RvMeYyc1LWMHtK8EbPv0iNZ8/oTtHPx9/cc2ILxQ+u905qIwdpULaqDkyBKgOaB57QTMg7ztg8Jm2Og=="
 crossorigin=""></script>

	<link rel="stylesheet" href="../dist/MarkerCluster.css" />
	<link rel="stylesheet" href="../dist/MarkerCluster.Default.css" />
  <script src="../dist/leaflet.markercluster-src.js"></script>
  
  <script src='https://unpkg.com/@mapbox/leaflet-pip@latest/leaflet-pip.js'></script>


	<style>
	#mapid { 
		height: 800px; 
		}

	.leaflet-popup-content {
        max-width: 300px;
        height: 300px;
        overflow-y: scroll;
            }

	</style>

  </head>
  <body>
	<div id="mapid"></div>
	

	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
	
	<script>
	var selected_features = null;

	var map = L.map('mapid').setView([-32.010405, 115.903015 ],9);
	//var friends= 'https://kmi.dbca.wa.gov.au/geoserver/public/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=public:friends_groups_may_2019&outputFormat=application%2Fjson';

	var streets= L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}', {
	attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
    maxZoom: 18,
    id: 'mapbox.streets',
    accessToken: 'pk.eyJ1IjoibWJha2hyYXliYSIsImEiOiJjanZldmpjcmUybmljNGVzMXpxNGxkbmw5In0.sNObGJvqNXa7C27fmxsm_Q'
	}).addTo(map);

	//var marker = L.marker([51.5, -0.09]).addTo(mymap);

	map.createPane('labels');
	map.getPane('labels').style.zIndex = 650;
	map.getPane('labels').style.pointerEvents = 'none';

	// var friends = new L.geoJson();
	var friends = []

	// var mcg=L.markerClusterGroup({
	// 	chunkedLoading: true,
	// 	spiderfyOnMaxZoom: false
	// });


$.ajax({
dataType: "json",
url: 'https://kmi.dbca.wa.gov.au/geoserver/public/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=public:friends_regional_groups_may_2019&outputFormat=application%2Fjson',
success: function(data) {
    $(data.features).each(function(key, data) {
        friends.push(data);
    });
	var categories = {},type;
	

	alllayer = L.geoJSON(friends, {
		style: function(feature) {
        switch (feature.properties.type) {
            case 'friends': return {color: "#ff0000"};
            case 'regional':   return {color: "#0000ff"};
        }
		
	},
	onEachFeature: function(feature,layer){

		// var popupText = '<p>Organisation: ' + feature.properties.org + '<br> Site: '
		// 	+ feature.properties.org +  '<br> Contact:'
		// 	+ feature.properties.contact + '<br><strong>P :</strong>'
		// 	+feature.properties.p +'<br><strong>E :</strong><a href="'+feature.properties.e+'"> '
		// 	+feature.properties.e + '</a><br><strong>W :</strong> <a href="'+feature.properties.w+'">'
		// 	+feature.properties.w + '</a><br><strong>F :</strong> <a href="'+feature.properties.f+'">'
		// 	+feature.properties.f + '</a><br><strong>About us :</strong>'
		// 	+feature.properties.about +
		// 	'</p>' ;

		// layer.bindPopup(popupText);
		type = feature.properties.type;

		if(typeof categories[type] === "undefined"){
			categories[type] = [];
		}
		categories[type].push(layer);

	}
	})

  function handleClick(e) {
    var html = '' ;
	selected_features = leafletPip.pointInLayer(
            // the clicked point
            e.latlng,
            // this layer
            alllayer,
            // whether to stop at first match
            false);
        if (selected_features.length) {
            for (var i = 0; i < selected_features.length; i++) { 
                (i === 0 )? html += "" : html += "<br>"+"_____" ;

                html +=        "<br><a class='zoomIn' >" + selected_features[i].feature.properties.org + "</a>" +
                         "<br><b>Site: </b>" + selected_features[i].feature.properties.site + 
                         "<br><b>Contact:</b> " + selected_features[i].feature.properties.contact + 
                         "<br><b>P: </b>" + selected_features[i].feature.properties.p + 
                         "<br><b>E: </b>" + selected_features[i].feature.properties.e +
                         "<br><b>W: </b>" + selected_features[i].feature.properties.w +
                         "<br><b>F: </b>" + selected_features[i].feature.properties.f +
                         "<br><b>About Us: </b>" + selected_features[i].feature.properties.about ;
                        
            }
        }
    if (html) {
        map.openPopup(html, e.latlng);     
    }
}
map.on('click', handleClick)


	var positron = L.tileLayer('http://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}.png', {
        attribution: '©OpenStreetMap, ©CartoDB'
}).addTo(map);

var positronLabels = L.tileLayer('http://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}.png', {
        attribution: '©OpenStreetMap, ©CartoDB',
        pane: 'labels'
}).addTo(map);


	var baseLayers = {
		"Streets": streets
	};

	var overlaysObj = {},
	TypeName,
        TypeArray,
        TypeLG;

      for (TypeName in categories) {
        TypeArray = categories[TypeName];
        TypeLG = L.layerGroup(TypeArray).addTo(map);
        TypeLG.TypeName = TypeName;
        overlaysObj[TypeName] = TypeLG;
      }
	  

      // Create an empty LayerGroup that will be used to emulate adding / removing all categories.
      /*var allPointsLG = L.layerGroup();
      overlaysObj["All Points"] = allPointsLG;*/

      var control = L.control.layers(baseLayers, overlaysObj, {
        collapsed: false
      }).addTo(map);

	//friends_layer.addTo(mymap);

	

}
}).error(function() {});
	// function onMapClick(e) {
	// 	popup.setLatLng(e.latlng)
	// 	popup.setContent("You clicked the map at " +e.latlng.toString())
	// 	popup.openOn(mymap)
		
	// }

	function highlightFeature(e) {
    var layer = e.target;

    layer.setStyle({
        weight: 5,
        color: '#666',
        dashArray: '',
        fillOpacity: 0.7
    });

    if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
        layer.bringToFront();
    }
}	
	function resetHighlight(e) {
		geojson.resetStyle(e.target);
	}

	</script>

  </body>
</html>